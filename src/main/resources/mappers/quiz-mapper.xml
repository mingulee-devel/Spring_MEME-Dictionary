<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  <mapper namespace="QuizMapper">
  	<resultMap type="Quiz" id="quizResultMap">
  		<id property="quizNo" column="QUIZ_NO"/>
  		<result property="quizType" column="QUIZ_TYPE"/>
  		<result property="quizQuest" column="QUIZ_QUESTION"/>
  		<result property="quizAnswer" column="QUIZ_ANSWER"/>
  		<result property="memberId" column="MEMBER_ID"/>
  		<result property="quizDate" column="QUIZ_DATE"/>
  		<result property="quizCh1" column="QUIZ_CH1"/>
  		<result property="quizCh2" column="QUIZ_CH2"/>
  		<result property="quizCh3" column="QUIZ_CH3"/>
  		<result property="quizCh4" column="QUIZ_CH4"/>
  	</resultMap>
  	
  	<!-- 마이페이지 -->
  	<select id="selectMyQuizList" parameterType="string" resultMap="quizResultMap">
  		SELECT * FROM QUIZ_TBL WHERE MEMBER_ID = #{memberId } ORDER BY QUIZ_NO DESC
  	</select>
  	
  	<select id="selectMyQuizCount" resultType="_int">
  		SELECT COUNT(*) FROM QUIZ_TBL WHERE MEMBER_ID = #{memberId }
  	</select>
  	
  	
  	<!-- 퀴즈 메인 -->
  	<select id="selectRandom" resultMap="quizResultMap">
  		SELECT QUIZ_NO FROM (SELECT QUIZ_NO FROM QUIZ_TBL ORDER BY DBMS_RANDOM.VALUE) WHERE <![CDATA[ROWNUM<=100]]>
  	</select>
  	
  	<select id="selectOneByNo" resultMap="quizResultMap">
  		SELECT * FROM QUIZ_TBL Q
		LEFT OUTER JOIN QUIZ_CH C
		ON Q.QUIZ_NO = C.QUIZ_NO
		WHERE Q.QUIZ_NO = #{quizNo}
  	</select>
  	
  	<insert id="insertQuiz" parameterType="Quiz">
  		INSERT INTO QUIZ_TBL VALUES(QUIZ_SEQ_NO.NEXTVAL, #{quizType}, #{quizQuest}, #{quizAnswer}, #{memberId}, DEFAULT)
  	</insert>
  	<insert id="insertQuizFile" parameterType="QuizFile">
		INSERT INTO QUIZ_FILE VALUES(QUIZ_SEQ_FILENO.NEXTVAL, #{quizFileName }, #{quizFileExtension }, #{quizFileRename }, QUIZ_SEQ_NO.CURRVAL)  	
  	</insert>
  	
  	<insert id="insertQuizM" parameterType="QuizCh">
  		INSERT INTO QUIZ_CH VALUES(QUIZ_SEQ_NO.CURRVAL, #{quizCh1}, #{quizCh2}, #{quizCh3}, #{quizCh4})
  	</insert>
  	
  	<select id="selectScore" resultType="_int">
  		SELECT QUIZ_BESTSCORE FROM QUIZ_BEST WHERE MEMBER_ID = #{memberId}
  	</select>
  	
  	<update id="updateScore" parameterType="QuizBest">
		MERGE INTO QUIZ_BEST USING DUAL ON (MEMBER_ID = #{memberId})
		WHEN MATCHED THEN
	    UPDATE SET QUIZ_BESTSCORE=#{bestScore}, QUIZ_BESTDATE = DEFAULT
		WHEN NOT MATCHED THEN
	    INSERT(MEMBER_ID, QUIZ_BESTSCORE, QUIZ_BESTDATE) VALUES(#{memberId}, #{bestScore}, DEFAULT)
  	</update>
  	<insert id="insertQuizReport" parameterType="QuizReport">
  		INSERT INTO QUIZ_REPORT VALUES(QUIZ_SEQ_REPORTNO.NEXTVAL, #{reportId}, #{reportContents}, DEFAULT, #{quizNo})
  	</insert>
  </mapper>